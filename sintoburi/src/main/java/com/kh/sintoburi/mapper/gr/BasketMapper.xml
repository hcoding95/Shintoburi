<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.kh.sintoburi.mapper.gr.BasketMapper">
 
 	<select id="getList" resultType="BasketDetailDto">
	select k.user_id, b.pno, p.name, i.img_path, b.p_count, p.price, b.p_count*p.price	total_price, b.put_date
	from tbl_basket_detail b, tbl_product p, tbl_img i, tbl_basket k
	where b.bno = k.bno
		and k.user_id = #{user_id}
		and b.pno = p.pno
		and p.pno = i.pno
	  </select>
	  
	  <insert id="insertSelectKey">
	  	<selectKey keyProperty="bno" order="BEFORE"	resultType="int">
			select seq_basket.nextval from dual
		</selectKey>
	  	insert into tbl_basket
	  		(bno, user_id)
	  	values
	  	    (#{bno}, #{user_id})	
	  </insert>
	  
	  <insert id="insertDetail">
		insert into tbl_basket_detail
			(bdno, pno, bno, p_count)
		values
			(seq_basket_detail.nextval, #{pno}, #{bno}, #{p_count})
	  </insert>
	  
	 <select id="getBnoByUser" resultType="int">
	 	with results as
		(
		  select bno, user_id
		  from tbl_basket b
		  where user_id = #{user_id}
		)
		select bno
		from results
		union all
		select 0
		from dual
		where not exists (select bno from results)
	 </select>
	  
	  <update id="update">
	  		update tbl_basket_detail set
	  			p_count = #{p_count}
	  		where bdno = #{bdno}
	  </update>
	  
	  <delete id="delete">
	  		delete from tbl_basket_detail
	  		where bdno = #{bdno}
	  </delete>
	  
	  <delete id="deleteAll">
	  		delete from tbl_basket_detail
	  		where bno = #{bno}
	  </delete>
 
  </mapper>